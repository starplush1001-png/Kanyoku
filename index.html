<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>慣用句学習アプリ（初級20問）</title>
<style>
body { font-family: sans-serif; margin: 20px; font-size: 1.3em; }
#controls { margin-bottom: 20px; text-align: center; }
button { margin: 5px; font-size: 1.3em; padding: 10px 14px; }

.phrase { 
  border: 2px solid #444; 
  padding: 20px; 
  margin: 10px auto; 
  width: 50%; /* 横幅50% */
  font-size: 1.3em; /* 文字サイズ1.3倍 */
  cursor: pointer; 
  display: block; /* 縦に並べる */
  text-align: left; /* 左詰め */
}

.front { font-weight: bold; }
.back { margin-left: 5px; font-weight: bold; text-transform: uppercase; }
</style>
</head>
<body>

<h1 style="text-align:center;">慣用句学習アプリ（初級）</h1>

<div id="controls">
  <label><input type="checkbox" id="toggleFront"> 前半を隠す</label>
  <label><input type="checkbox" id="randomOrder"> ランダム出題</label>
  <label><input type="checkbox" id="weakMode"> 苦手問題優先</label>
  <br>
  <label>プレーヤー:</label>
  <label><input type="checkbox" class="player" value="ミナト"> ミナト</label>
  <label><input type="checkbox" class="player" value="ソウワ" checked> ソウワ</label>
  <label><input type="checkbox" class="player" value="ヒロ"> ヒロ</label>
  <label><input type="checkbox" class="player" value="トモ"> トモ</label>
</div>

<div id="questions"></div>

<div style="text-align:center;">
  <button id="showAnswerBtn">答えを見る</button>
  <button id="nextBtn">次の5問</button>
</div>

<script>
// 小学二年生以下向けの慣用句20問
const phrases = [
  ["猫に","小判"],
  ["二兎をおう者は","一兎をも得ず"],
  ["逃がした魚は","大きい"],
  ["灯台もと","暗し"],
  ["善は","急げ"],
  ["石橋を","たたいて渡る"],
  ["三度目の","正直"],
  ["七転び","八起き"],
  ["急がば","回れ"]
  ["論より","証拠"],
  ["類は","友を呼ぶ"],
  ["良薬は","口ににがし"],
  ["立て板に","水"],
  ["餅は","餅屋"],
  ["壁に","耳あり"],
  ["百聞は","一見にしかず"],
  ["備えあれば","うれいなし"],
  ["飛ぶ鳥","後をにごさず"],
  ["背に腹は","かえられぬ"],
  ["馬の耳に","念仏"],  
];

const questionsDiv = document.getElementById("questions");
const showAnswerBtn = document.getElementById("showAnswerBtn");
const nextBtn = document.getElementById("nextBtn");
const toggleFront = document.getElementById("toggleFront");
const randomOrderCheckbox = document.getElementById("randomOrder");
const weakModeCheckbox = document.getElementById("weakMode");
const playerCheckboxes = document.querySelectorAll(".player");

const players = Array.from(playerCheckboxes).map(c=>c.value);
let playerHistory = {};
players.forEach(p => { playerHistory[p] = {}; });

let currentOrder = [];
let currentIndex = 0;
const questionsPerPage = 5;

function getSelectedPlayers(){
  return Array.from(playerCheckboxes).filter(c=>c.checked).map(c=>c.value);
}

function prepareQuestionOrder(){
  if(weakModeCheckbox.checked){
    let totalWrongList = phrases.map((_,idx)=>{
      let total=0;
      Object.keys(playerHistory).forEach(p=>{
        total += playerHistory[p][idx]||0;
      });
      return {idx,total};
    });
    totalWrongList.sort((a,b)=>b.total - a.total);
    currentOrder = totalWrongList.map(o=>o.idx);
  } else {
    currentOrder = phrases.map((_,i)=>i);
    if(randomOrderCheckbox.checked) currentOrder.sort(()=>Math.random()-0.5);
  }
}

function updateFrontVisibility(){
  const hideFront = toggleFront.checked;
  document.querySelectorAll(".phrase").forEach(div=>{
    const frontSpan = div.querySelector(".front");
    frontSpan.style.visibility = hideFront ? "hidden" : "visible";
    if(div.dataset.state==="hidden") div.querySelector(".back").style.visibility = hideFront ? "visible" : "hidden";
  });
}

function displayQuestions(){
  prepareQuestionOrder();
  questionsDiv.innerHTML="";
  const selPlayers = getSelectedPlayers();

  for(let i=0;i<questionsPerPage;i++){
    let idx = currentOrder[currentIndex+i];
    if(idx===undefined){
      currentIndex=0;
      idx = currentOrder[currentIndex+i];
      if(idx===undefined) break;
    }
    const [front,back] = phrases[idx];
    const div = document.createElement("div");
    div.classList.add("phrase");
    div.dataset.idx = idx;
    div.dataset.state = "hidden"; // hidden -> shown -> counted

    let countText = selPlayers.map(p=>`${playerHistory[p][idx]||0}`).join(" ");
    if(countText) countText = `[${countText}] `;

    div.innerHTML = `${countText}<span class="front">${front}</span> <span class="back">${back.toUpperCase()}</span>`;
    
    div.querySelector(".back").style.visibility = toggleFront.checked ? "visible" : "hidden";

    div.addEventListener("click", ()=>{
      if(div.dataset.state === "hidden"){
        div.querySelector(".back").style.visibility = "visible";
        div.dataset.state = "shown";
      } else if(div.dataset.state === "shown"){
        selPlayers.forEach(p=>{
          playerHistory[p][idx] = (playerHistory[p][idx]||0) + 1;
        });
        div.dataset.state = "counted";
        let newCountText = selPlayers.map(p=>`${playerHistory[p][idx]||0}`).join(" ");
        div.innerHTML = `[${newCountText}] <span class="front">${front}</span> <span class="back">${back.toUpperCase()}</span>`;
      }
    });

    questionsDiv.appendChild(div);
  }
  updateFrontVisibility();
  showAnswerBtn.disabled=false;
}

showAnswerBtn.addEventListener("click", ()=>{
  document.querySelectorAll(".phrase .back").forEach(span=>{
    span.style.visibility = "visible";
  });
});

nextBtn.addEventListener("click", ()=>{
  currentIndex += questionsPerPage;
  displayQuestions();
});

toggleFront.addEventListener("change", updateFrontVisibility);
randomOrderCheckbox.addEventListener("change", ()=>{ currentIndex=0; displayQuestions(); });
weakModeCheckbox.addEventListener("change", ()=>{ currentIndex=0; displayQuestions(); });
playerCheckboxes.forEach(c=>c.addEventListener("change", ()=>{ displayQuestions(); }));

displayQuestions();
</script>
</body>
</html>
